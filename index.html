<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Order Creator</title>
    <!-- <link rel="stylesheet" href="./style.css"> -->
    <!-- <link rel="icon" href="./favicon.ico" type="image/x-icon"> -->
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>
  <body>
    <!-- <nav>
      <div class="nav-wrapper">
        <div class="container">
          <a href="#" class="brand-logo">Angel v1.0</a>
          <ul id="nav-mobile" class="right hide-on-med-and-down">
            <li><a href="#" onclick="testClick('reset clicked')">Reset</a></li>
          </ul>
        </div>
      </div>
    </nav> -->

  <div class="container" hidden id="tradebutton">
    <!-- <blockquote id="orderDetails"></blockquote> -->
    <blockquote><h5>Order Details</h5></blockquote>
    <div class="row">
      <div class="col s5">
        <table class="striped">
          <thead>
            <th>Parameter</th>
            <th>Value</th>
          </thead>
          <tbody>
            <tr>
              <td>Exchange</td>
              <td id="exchange"></td>
            </tr>
            <tr>
              <td>Variety</td>
              <td id="variety"></td>
            </tr>
            <tr>
              <td>Transaction Type</td>
              <td id="transactiontype"></td>
            </tr>
            <tr>
              <td>Product Type</td>
              <td id="producttype"></td>
            </tr>
            <tr>
              <td>Order Type</td>
              <td id="ordertype"></td>
            </tr>
            <tr>
              <td>Duration</td>
              <td id="validity"></td>
            </tr>
            <tr>
              <td>Scrip Code</td>
              <td id="tradingsymbol"></td>
            </tr>
            <tr>
              <td>Price</td>
              <td id="price"></td>
            </tr>
            <tr>
              <td>Lots</td>
              <td id="quantity"></td>
            </tr>
            <tr>
              <td>Target</td>
              <td id="squareoff"></td>
            </tr>
            <tr>
              <td>Stoploss</td>
              <td id="stoploss"></td>
            </tr>
            <tr>
              <td>Trailing SL</td>
              <td id="trailingstoploss"></td>
            </tr>
            <tr>
              <td>Trigger</td>
              <td id="triggerprice"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <p id="default-button"> </p>
    <button id="custom-button" class="waves-effect waves-light btn red">Click here to Proceed</button>

  </div>

  <div class="container" id="createOrder" hidden>
      <h5>New Order</h5>
          <form action="orderSubmit()" id="orderForm" class="col s12">
            <div class="row">
              <div class="input-field col s3">
                <input value="ROBO" id="variety" type="text" class="validate" required>
                <label for="variety">Variety</label>
              </div>
              <div class="input-field col s2">
                <input value="BUY" id="transactiontype" type="text" class="validate" required>
                <label for="transactiontype">Transaction Type</label>
              </div>
              <div class="input-field col s2">
                <input value="BO" id="producttype" type="text" class="validate" required>
                <label for="producttype">Product Type</label>
              </div>
              <div class="input-field col s3">
                <input value="STOPLOSS_LIMIT" id="ordertype" type="text" class="validate" required>
                <label for="ordertype">Order Type</label>
              </div>
              <div class="input-field col s2">
                <input value="DAY" id="duration" type="text" class="validate" required>
                <label for="duration">Duration</label>
              </div>
            </div>
            <div class="row">
                <div class="input-field col s3">
                  <input id="exchange" type="text" value="NFO" class="validate" required>
                  <label for="exchange">Exchange</label>
                </div>
                <div class="input-field col s3">
                  <input placeholder="NIFTY03NOV2217800CE" id="scrip" type="text" class="validate" required>
                  <label for="scrip">Scrip Code</label>
                </div>
            </div>
            <div class="row">
              <div class="input-field col s2">
                <input value="1" id="quantity" min="1" type="number" class="validate" required>
                <label for="quantity">Lots</label>
              </div>
              <div class="input-field col s2">
                <input placeholder="0" min="0" id="price" type="number" class="validate" required>
                <label for="price">Price</label>
              </div>
              <div class="input-field col s2">
                <input placeholder="0" id="trigger" min="0" type="number" class="validate" required>
                <label for="trigger">Trigger</label>
              </div>
              <div class="input-field col s2">
                <input placeholder="0" id="target" min="0" type="number" class="validate" required>
                <label for="target">Target</label>
              </div>
              <div class="input-field col s2">
                <input placeholder="0" id="stoploss" min="0" type="number" class="validate" required>
                <label for="stoploss">Stop Loss</label>
              </div>
              <div class="input-field col s2">
                <input value="0" id="trailingstoploss" min="0" type="number" class="validate" required>
                <label for="trailingstoploss">Trailing SL</label>
              </div>
            </div>
          </form>
          <div class="col s3">
            <button class="btn waves-effect waves-light" onclick="orderSubmit()">Create
              <i class="material-icons right">send</i>
            </button>
        </div>
    </div>
    <div class="container">
      <div id="verifycopy" hidden>
        <p>URL</p>
        <!-- <div class="row">
          <div class="col s3"> </div>
        </div> -->
        <div class="row">
          <div class="col s12"><blockquote><a href="" id="displayURL"></a></blockquote></div>
        </div>
      </div>
    </div>

	<script src="index.js"></script>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://smartapi.angelbroking.com/common/v1.js"></script>
    <script>
        function clickTradeButton() {
          document.getElementById('custom-button').click()
        }

        function renderTradeButton(orderData) {

          document.getElementById('default-button').innerHTML = '';
          document.getElementById('tradebutton').hidden = false;
          // document.getElementById('orderDetails').innerHTML = JSON.stringify(orderData);

          SmartApiConnect.ready(function () { 

            var smartApi = new SmartApiConnect("smartapi_key"); 

            smartApi.add(orderData); 
            // smartApi.renderButton("#default-button"); 
            smartApi.link("#custom-button")

            smartApi.finished(function (status,acess_token) {
                console.log('smartApi.finished  Status',status);
                console.log('smartApi.finished  Tokens',acess_token);
            });

          }); 
        }

        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('exchange') == null) {
          document.getElementById('createOrder').hidden = false
        } else {
          var orderData = {
            "variety": urlParams.get('variety'),
            "tradingsymbol": urlParams.get('tradingsymbol'),
            "exchange": urlParams.get('exchange'),
            "transactiontype": urlParams.get('transactiontype'),
            "ordertype": urlParams.get('ordertype'),
            "quantity": urlParams.get('quantity'),
            "producttype": urlParams.get('producttype'),
            "price": urlParams.get('price'),
            "triggerprice": urlParams.get('triggerprice'),
            "stoploss": urlParams.get('stoploss'),
            "squareoff": urlParams.get('squareoff'),
            "trailingstoploss": urlParams.get('trailingstoploss'),
            "validity": urlParams.get('validity')
          }

          document.getElementById("exchange").innerHTML = orderData.exchange;
          document.getElementById("variety").innerHTML = orderData.variety;
          document.getElementById("transactiontype").innerHTML = orderData.transactiontype;
          document.getElementById("producttype").innerHTML = orderData.producttype;
          document.getElementById("ordertype").innerHTML = orderData.ordertype;
          document.getElementById("validity").innerHTML = orderData.validity;
          document.getElementById("tradingsymbol").innerHTML = orderData.tradingsymbol;
          document.getElementById("price").innerHTML = orderData.price;
          document.getElementById("quantity").innerHTML = orderData.quantity;
          document.getElementById("squareoff").innerHTML = orderData.squareoff;
          document.getElementById("stoploss").innerHTML = orderData.stoploss;
          document.getElementById("trailingstoploss").innerHTML = orderData.trailingstoploss;
          document.getElementById("triggerprice").innerHTML = orderData.triggerprice;

          renderTradeButton(orderData);
          // setTimeout(function() {
          //   document.getElementById("custom-button").click()
          // }, 2000)
          
        };

        function orderSubmit() {
          let formData = document.getElementById("orderForm").elements;
          let orderData = {
            "variety": formData.item(0).value,
            "tradingsymbol": formData.item(6).value,
            "exchange": formData.item(5).value,
            "transactiontype": formData.item(1).value,
            "ordertype": formData.item(3).value,
            "quantity": formData.item(7).value,
            "producttype": formData.item(2).value,
            "price": formData.item(8).value,
            "triggerprice": formData.item(9).value,
            "stoploss": formData.item(11).value,
            "squareoff": formData.item(10).value,
            "trailingstoploss": formData.item(12).value,
            "validity": formData.item(4).value
          }
          console.log(orderData);

          document.getElementById('verifycopy').hidden = false;

          let querystring = new URLSearchParams(orderData).toString();
          document.getElementById("displayURL").innerHTML = window.location.href+'?'+querystring;
          document.getElementById("displayURL").href = window.location.href+'?'+querystring;

          // navigator.clipboard.writeText(window.location.href+querystring);

        }

        function testClick(message) {
          alert(message)
        }

    </script>
    <script>
      M.AutoInit();
    </script>
    <style>
      td {
        padding: 5px;
      }
    </style>
  </body>
</html>